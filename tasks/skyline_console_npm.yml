---
# Copyright 2022, BBC R&D.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Install nvm
  ansible.builtin.shell: >
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash
  args:
    executable: /bin/bash
    chdir: "$HOME"
    creates: "$HOME/.nvm/nvm.sh"

- name: Setup .profile
  ansible.builtin.lineinfile:
    path: ~/.profile
    line: source ~/.nvm/nvm.sh # This will make sure Node is on the user's PATH
    create: yes

- name: Install node
  ansible.builtin.shell: "{{ '/bin/bash -ic ' ~ '\"nvm install --lts=' ~ item ~ '\"' }}"
  args:
    chdir: "$HOME"
    creates: "$HOME/.nvm/versions/node/{{ item }}"
  register: _node_install
  changed_when: "'already installed' not in _node_install.stderr"
  loop:
    - "erbium"

- name: Clone skyline git repo
  git:
    repo: https://opendev.org/openstack/skyline-console.git
    dest: /opt/skyline-console
    force: yes

- name: Install yarn node.js package.
  community.general.npm:
    name: yarn
    path: "/opt/skyline-console"

- name: Install packges with yarn
  ansible.builtin.shell: "{{ '/bin/bash -ic ' ~ '\"node_modules/yarn/bin/yarn install\"' }}"
  args:
    chdir: "/opt/skyline-console"

- name: Install build application with yarn
  ansible.builtin.shell: "{{ '/bin/bash -ic ' ~ '\"node_modules/yarn/bin/yarn run build\"' }}"
  args:
    chdir: "/opt/skyline-console"

- name: Copy the static content to /var/www
  copy:
    src: "/opt/skyline-console/skyline_console/static"
    dest: "{{ skyline_static_files_dir }}"
    remote_src: true
    owner: "{{ skyline_system_user_name }}"
    group: www-data
    mode: 0755

